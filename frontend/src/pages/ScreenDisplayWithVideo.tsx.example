/**
 * å±å¹•æ˜¾ç¤ºé¡µé¢ - é›†æˆè§†é¢‘æµæ¨¡å¼ç¤ºä¾‹
 * 
 * è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº†å¦‚ä½•åœ¨ç°æœ‰çš„ ScreenDisplay é¡µé¢ä¸­é›†æˆè§†é¢‘æµåŠŸèƒ½
 * å¯ä»¥å‚è€ƒè¿™ä¸ªç¤ºä¾‹æ¥ä¿®æ”¹ä½ çš„ ScreenDisplay.tsx
 */

import { useEffect, useRef, useState } from 'react'
import { useSelector, useDispatch } from 'react-redux'
import { RootState, AppDispatch } from '../store'
import { selectDevice } from '../features/deviceSlice'
import { 
  Card, 
  Select, 
  Button, 
  Row, 
  Col, 
  Typography, 
  Spin, 
  Slider,
  message,
  Space,
  Tag,
  Switch,
  Divider,
} from 'antd'
import { 
  ArrowLeftOutlined,
  FullscreenOutlined,
  ThunderboltOutlined,
  CameraOutlined,
} from '@ant-design/icons'
import { useNavigate } from 'react-router-dom'
import { ScrcpyPlayer } from '../components/ScrcpyPlayer'
import { useWebSocketManager } from '../hooks/useWebSocketManager'

const { Text, Title } = Typography

const ScreenDisplayWithVideo = () => {
  const dispatch = useDispatch<AppDispatch>()
  const navigate = useNavigate()
  const { devices, selectedDevice } = useSelector((state: RootState) => state.devices)
  
  // æ˜¾ç¤ºæ¨¡å¼ï¼š'screenshot' æˆ– 'video'
  const [displayMode, setDisplayMode] = useState<'screenshot' | 'video'>('video')
  const [quality, setQuality] = useState(4) // è§†é¢‘è´¨é‡(1-8 Mbps)
  const [resolution, setResolution] = useState(1080) // åˆ†è¾¨ç‡
  
  // æˆªå›¾æ¨¡å¼çš„ WebSocket è¿æ¥
  const { lastMessage, readyState, isConnected: screenshotConnected } = useWebSocketManager(
    displayMode === 'screenshot' ? selectedDevice : null
  )
  
  // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ WebCodecs
  const isWebCodecsSupported = () => {
    return typeof window !== 'undefined' && 'VideoDecoder' in window
  }
  
  // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ WebCodecsï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼
  useEffect(() => {
    if (!isWebCodecsSupported() && displayMode === 'video') {
      message.warning('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æµæ¨¡å¼ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼')
      setDisplayMode('screenshot')
    }
  }, [displayMode])
  
  // å¤„ç†æˆªå›¾æµ
  useEffect(() => {
    if (displayMode !== 'screenshot' || !lastMessage) return
    
    try {
      const data = lastMessage
      if (data.type === 'screenshot' && data.data) {
        const container = document.getElementById('screenshot-container')
        if (!container) return
        
        let img = container.querySelector('img') as HTMLImageElement
        if (!img) {
          img = document.createElement('img')
          img.style.width = '100%'
          img.style.height = '100%'
          img.style.objectFit = 'contain'
          container.appendChild(img)
        }
        
        if (img.src && img.src.startsWith('blob:')) {
          URL.revokeObjectURL(img.src)
        }
        img.src = data.data
      }
    } catch (e) {
      console.error('å¤„ç†æˆªå›¾å¤±è´¥:', e)
    }
  }, [lastMessage, displayMode])
  
  // åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
  const handleModeChange = (checked: boolean) => {
    const newMode = checked ? 'video' : 'screenshot'
    
    if (newMode === 'video' && !isWebCodecsSupported()) {
      message.error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æµæ¨¡å¼ï¼Œè¯·ä½¿ç”¨ Chrome 94+ æˆ– Edge 94+')
      return
    }
    
    setDisplayMode(newMode)
    message.success(`å·²åˆ‡æ¢åˆ°${newMode === 'video' ? 'è§†é¢‘æµ' : 'æˆªå›¾'}æ¨¡å¼`)
  }
  
  // è®¾å¤‡é€‰é¡¹
  const deviceOptions = devices.map(device => ({
    label: `${device.device_id} (${device.name || 'æœªçŸ¥è®¾å¤‡'})`,
    value: device.device_id
  }))
  
  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Card 
        styles={{ body: { padding: '0', height: '100%', display: 'flex', flexDirection: 'column', overflow: 'hidden' } }}
        style={{ height: '100%', display: 'flex', flexDirection: 'column' }}
        variant="borderless"
      >
        {/* é¡¶éƒ¨æ ‡é¢˜æ  */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          padding: '0px 16px',
          borderBottom: '1px solid #f0f0f0'
        }}>
          <Title level={4} style={{ margin: 0 }}>å®æ—¶å±å¹•æ˜¾ç¤º</Title>
          <Space>
            <Button icon={<ArrowLeftOutlined />} onClick={() => navigate('/')}>
              è¿”å›è®¾å¤‡åˆ—è¡¨
            </Button>
          </Space>
        </div>
        
        <Row gutter={0} style={{ marginTop: 0, flex: 1, overflow: 'hidden' }}>
          {/* å·¦ä¾§ï¼šå®æ—¶å±å¹•é¢„è§ˆ */}
          <Col xs={24} lg={16} style={{ paddingRight: 12, display: 'flex', alignItems: 'stretch', height: '100%' }}>
            <div style={{ width: '100%', display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '16px' }}>
              <div
                style={{
                  width: '100%',
                  maxWidth: 500,
                  aspectRatio: '9 / 19.5',
                  borderRadius: 28,
                  padding: 8,
                  background: '#1f1f1f',
                  boxShadow: '0 12px 28px rgba(0,0,0,0.25)',
                  border: '4px solid #2d2d2d',
                  display: 'flex',
                  justifyContent: 'center',
                  alignItems: 'center',
                }}
              >
                <div
                  style={{
                    width: '100%',
                    height: '100%',
                    borderRadius: 20,
                    overflow: 'hidden',
                    backgroundColor: '#000',
                    position: 'relative',
                  }}
                >
                  {/* è§†é¢‘æµæ¨¡å¼ */}
                  {displayMode === 'video' && selectedDevice && (
                    <ScrcpyPlayer
                      deviceId={selectedDevice}
                      maxSize={resolution}
                      bitRate={quality * 1_000_000}
                      onReady={() => message.success('è§†é¢‘æµå·²è¿æ¥')}
                      onError={(err) => message.error(`è§†é¢‘æµé”™è¯¯: ${err}`)}
                    />
                  )}
                  
                  {/* æˆªå›¾æ¨¡å¼ */}
                  {displayMode === 'screenshot' && (
                    <div 
                      id="screenshot-container"
                      style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                    >
                      {!selectedDevice && (
                        <Text style={{ color: '#fff' }}>è¯·é€‰æ‹©è®¾å¤‡</Text>
                      )}
                      {selectedDevice && readyState !== 1 && (
                        <Spin size="large" />
                      )}
                    </div>
                  )}
                  
                  {/* æ¨¡å¼æ ‡ç­¾ */}
                  <div
                    style={{
                      position: 'absolute',
                      top: 8,
                      right: 8,
                      padding: '4px 8px',
                      background: 'rgba(0,0,0,0.6)',
                      borderRadius: 4,
                    }}
                  >
                    <Tag color={displayMode === 'video' ? 'blue' : 'green'} style={{ margin: 0 }}>
                      {displayMode === 'video' ? 'è§†é¢‘æµ' : 'æˆªå›¾æ¨¡å¼'}
                    </Tag>
                  </div>
                </div>
              </div>
            </div>
          </Col>

          {/* å³ä¾§ï¼šæ§åˆ¶åŒºåŸŸ */}
          <Col xs={24} lg={8} style={{ paddingLeft: 12, borderLeft: '1px solid #e8e8e8', height: '100%', overflow: 'auto' }}>
            <div style={{ padding: '16px' }}>
              {/* è®¾å¤‡é€‰æ‹© */}
              <Typography.Title level={5} style={{ marginTop: 0 }}>è®¾å¤‡é€‰æ‹©</Typography.Title>
              <Select
                value={selectedDevice}
                onChange={(value) => dispatch(selectDevice(value))}
                options={deviceOptions}
                style={{ width: '100%', marginBottom: 16 }}
                placeholder="è¯·é€‰æ‹©è®¾å¤‡"
              />

              <Divider />

              {/* æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ */}
              <Typography.Title level={5}>æ˜¾ç¤ºæ¨¡å¼</Typography.Title>
              <Space direction="vertical" style={{ width: '100%' }} size="middle">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <Space>
                    <CameraOutlined />
                    <Text>æˆªå›¾æ¨¡å¼</Text>
                  </Space>
                  <Switch
                    checked={displayMode === 'video'}
                    onChange={handleModeChange}
                    checkedChildren={<ThunderboltOutlined />}
                    unCheckedChildren={<CameraOutlined />}
                    disabled={!isWebCodecsSupported()}
                  />
                  <Space>
                    <ThunderboltOutlined />
                    <Text>è§†é¢‘æµ</Text>
                  </Space>
                </div>
                
                {!isWebCodecsSupported() && (
                  <Text type="warning" style={{ fontSize: 12 }}>
                    å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æµæ¨¡å¼ï¼Œè¯·ä½¿ç”¨ Chrome 94+ æˆ– Edge 94+
                  </Text>
                )}
                
                <div style={{ padding: 8, background: '#f5f5f5', borderRadius: 4 }}>
                  <Text type="secondary" style={{ fontSize: 12 }}>
                    {displayMode === 'video' ? (
                      <>
                        <strong>è§†é¢‘æµæ¨¡å¼</strong>: å»¶è¿Ÿ 30-100msï¼Œå¸§ç‡ 20-30 FPSï¼Œç¡¬ä»¶åŠ é€Ÿ
                      </>
                    ) : (
                      <>
                        <strong>æˆªå›¾æ¨¡å¼</strong>: å»¶è¿Ÿ 100-300msï¼Œå¸§ç‡ 10-20 FPSï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨
                      </>
                    )}
                  </Text>
                </div>
              </Space>

              <Divider />

              {/* ç”»è´¨è®¾ç½® */}
              <Typography.Title level={5}>ç”»è´¨è®¾ç½®</Typography.Title>
              <Space direction="vertical" style={{ width: '100%' }} size="middle">
                <div>
                  <Text strong>è§†é¢‘è´¨é‡ï¼š</Text>
                  <Text>{quality} Mbps</Text>
                  <Slider 
                    min={1} 
                    max={8} 
                    value={quality} 
                    onChange={setQuality}
                    step={1}
                    marks={{
                      1: 'çœæµ',
                      4: 'æ ‡å‡†',
                      8: 'é«˜æ¸…'
                    }}
                    style={{ marginTop: 8 }}
                  />
                </div>
                
                <div>
                  <Text strong>åˆ†è¾¨ç‡ï¼š</Text>
                  <Text>{resolution}p</Text>
                  <Slider 
                    min={480} 
                    max={1920} 
                    value={resolution} 
                    onChange={setResolution}
                    step={null}
                    marks={{
                      480: '480p',
                      720: '720p',
                      1080: '1080p',
                      1920: '1080p+'
                    }}
                    style={{ marginTop: 8 }}
                  />
                </div>
                
                <div style={{ padding: 8, background: '#e6f7ff', borderRadius: 4, border: '1px solid #91d5ff' }}>
                  <Text type="secondary" style={{ fontSize: 12 }}>
                    ğŸ’¡ æç¤ºï¼šé™ä½è´¨é‡å’Œåˆ†è¾¨ç‡å¯ä»¥å‡å°‘å»¶è¿Ÿå’Œå¸¦å®½å ç”¨
                  </Text>
                </div>
              </Space>
            </div>
          </Col>
        </Row>
      </Card>
    </div>
  )
}

export default ScreenDisplayWithVideo
