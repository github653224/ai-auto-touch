# 服务启动顺序说明

## 📋 服务架构

系统包含 **3个服务**，需要按顺序启动：

```
┌─────────────────┐
│   前端服务       │  http://localhost:3000
│  (React + Vite)  │  用户界面
└─────────────────┘
         ↓ 请求
┌─────────────────┐
│  后端主服务      │  http://localhost:8001
│  (FastAPI)       │  设备管理、AI控制、WebSocket
└─────────────────┘
         ↓ 请求
┌─────────────────┐
│  AI模型服务      │  http://localhost:8000
│  (vLLM/本地)     │  大模型推理服务
└─────────────────┘
```

## 🚀 启动顺序（推荐：分别启动，便于查看日志）

### ⭐ 推荐方式：分别启动（前台运行，日志可见）

#### 第一步：启动 AI 模型服务（8000端口）

**在新终端窗口运行：**
```bash
cd backend
./start_model.sh
```

**说明：**
- 前台运行，所有日志直接显示在终端
- 自动检测并使用 vLLM（如果已安装）或本地模型服务
- 启动可能需要较长时间，请耐心等待
- 按 `Ctrl+C` 停止服务

**验证：** 等待服务启动后，访问 http://localhost:8000/v1/models 应该返回模型信息

---

#### 第二步：启动后端主服务（8001端口）

**在另一个新终端窗口运行：**
```bash
cd backend
./start_backend.sh
```

**说明：**
- 前台运行，所有日志直接显示在终端
- 自动检测AI模型服务是否已启动
- 支持热重载（代码修改后自动重启）
- 按 `Ctrl+C` 停止服务

**验证：** 访问 http://localhost:8001/docs 应该看到 API 文档

---

#### 第三步：启动前端服务（3000端口）

**在第三个新终端窗口运行：**
```bash
cd frontend
npm run dev
```

**验证：** 浏览器访问 http://localhost:3000 应该看到界面

---

### 📋 其他启动方式

#### 后台运行（不推荐，日志在文件中）

**AI模型服务：**
```bash
cd backend
./start_vllm.sh          # vLLM（后台运行）
# 或
./start_local_model.sh  # 本地模型（后台运行）
```

**后端主服务：**
```bash
cd backend
nohup uvicorn main:app --host 0.0.0.0 --port 8001 --reload > logs/backend.log 2>&1 &
```

**查看日志：**
```bash
tail -f logs/vllm.log        # vLLM日志
tail -f logs/local_model.log # 本地模型日志
tail -f logs/backend.log     # 后端日志
```

**验证：** 访问 http://localhost:8001/docs 应该看到 API 文档

---

### 第三步：启动前端服务（3000端口）

```bash
cd frontend
npm run dev
```

**验证：** 浏览器访问 http://localhost:3000 应该看到界面

---

## ⚠️ 常见问题

### 1. 端口冲突
- **8000端口被占用**：AI 模型服务无法启动
  - 解决：检查是否有其他服务占用，或修改配置
- **8001端口被占用**：后端主服务无法启动
  - 解决：停止占用端口的服务，或修改 `backend/.env` 中的 `PORT`

### 2. 服务启动失败
- **AI模型服务未启动**：后端主服务会提示警告，但可以继续运行（只是AI功能不可用）
- **后端主服务未启动**：前端会报 404 错误

### 3. 检查服务状态

```bash
# 检查所有服务端口
lsof -i :8000  # AI模型服务
lsof -i :8001  # 后端主服务
lsof -i :3000  # 前端服务
```

---

## 📝 快速启动命令

### ⭐ 推荐：分别启动（3个终端窗口）

**终端1 - AI模型服务：**
```bash
cd /Users/rock/Documents/ai-auto-touch/backend
./start_model.sh
```

**终端2 - 后端主服务：**
```bash
cd /Users/rock/Documents/ai-auto-touch/backend
./start_backend.sh
```

**终端3 - 前端服务：**
```bash
cd /Users/rock/Documents/ai-auto-touch/frontend
npm run dev
```

### 查看启动指南

```bash
cd /Users/rock/Documents/ai-auto-touch/backend
./start_all.sh
```

这会显示：
- 启动指南
- 当前服务状态
- 快速启动命令

---

## 🔄 停止服务

按 `Ctrl+C` 停止各个服务，建议按相反顺序停止：
1. 先停止前端（Ctrl+C）
2. 再停止后端主服务（Ctrl+C）
3. 最后停止AI模型服务（Ctrl+C）

---

## 💡 提示

- 所有服务都需要在 **conda环境 `ai-auto-touch`** 中运行（除了前端）
- 确保设备已通过 ADB 连接：`adb devices`
- 如果只想测试设备管理功能，可以跳过AI模型服务（但AI控制功能不可用）

