# 画质实时更新故障排查指南

## 问题：调整画质/分辨率时仍显示"将在下次连接时生效"

### 检查步骤

#### 1. 确认当前模式

打开浏览器开发者工具（F12），查看控制台日志：

```
🔍 ScreenDisplay 状态: {
  useVideo: true/false,  // 必须是 true
  hasUpdateConfig: true/false,  // 必须是 true
  h264Supported: true/false,
  selectedDevice: "设备ID"
}
```

**如果 `useVideo: false`**：
- 原因：你当前在"截图模式"，不是"低延迟视频"模式
- 解决：在右侧"设备与画质设置"中，将"显示模式"开关切换到"低延迟视频"

**如果 `hasUpdateConfig: false`**：
- 原因：`updateConfig` 函数未正确返回
- 解决：检查代码是否正确编译，尝试刷新页面

#### 2. 检查 WebSocket 连接状态

调整画质/分辨率时，查看控制台日志：

```
🎨 调整视频质量: { value: 2, useVideo: true, hasUpdateConfig: true }
🔧 updateConfig 被调用: {
  config: { bitRate: 2 },
  wsExists: true/false,  // 必须是 true
  wsReadyState: 1,  // 必须是 1 (OPEN)
  enabled: true,
  deviceId: "设备ID"
}
```

**如果 `wsExists: false` 或 `wsReadyState` 不是 1**：
- 原因：WebSocket 连接未建立或已断开
- 解决：
  1. 检查连接状态指示器（右上角应显示"已连接"）
  2. 如果显示"未连接"，等待连接建立
  3. 如果长时间未连接，尝试刷新页面或重新选择设备

#### 3. 检查是否发送配置消息

如果 WebSocket 已连接，应该看到：

```
📤 已发送实时配置更新: 分辨率=720p, 比特率=2Mbps
```

**如果没有看到这条日志**：
- 原因：配置消息发送失败
- 解决：查看是否有错误日志，检查网络连接

#### 4. 检查后端日志

在后端控制台应该看到：

```
设备 <device_id>: 更新H264配置 - max_size=720, bit_rate=2000000
设备 <device_id>: 配置已更新，需要重启流以应用新配置
设备 <device_id> H264 视频流已停止
设备 <device_id>: 启动H264流 - max_size=720, bit_rate=2000000
```

**如果后端没有收到消息**：
- 原因：WebSocket 消息未到达后端
- 解决：
  1. 检查后端服务是否正常运行
  2. 检查网络连接
  3. 查看浏览器网络面板（Network -> WS）

### 常见问题

#### Q1: 我确认在"低延迟视频"模式，但仍显示"将在下次连接时生效"

**检查清单**：
1. 打开浏览器控制台，查看 `🔍 ScreenDisplay 状态` 日志
2. 确认 `useVideo: true` 和 `hasUpdateConfig: true`
3. 调整画质时，查看 `🎨 调整视频质量` 日志
4. 如果看到 `⚠️ 当前在截图模式`，说明状态不同步，尝试刷新页面
5. 如果看到 `⚠️ updateConfig 函数不可用`，说明代码未正确编译

#### Q2: 配置更新后视频流没有重启

**可能原因**：
1. 后端未收到配置消息
2. 后端处理配置消息时出错

**解决方法**：
1. 查看后端日志是否有错误
2. 检查后端 WebSocket 连接是否正常
3. 尝试断开重连

#### Q3: 视频流重启后画质/分辨率没有变化

**可能原因**：
1. 设备不支持请求的分辨率
2. 比特率变化不够明显

**解决方法**：
1. 尝试更大的调整幅度（例如从 5 Mbps 降到 1 Mbps）
2. 检查设备是否支持高分辨率（4K）
3. 查看后端日志确认配置已应用

### 快速测试

运行以下测试来验证功能：

1. **打开屏幕显示页面**
2. **切换到"低延迟视频"模式**
3. **打开浏览器控制台**
4. **调整画质滑块**
5. **检查控制台日志**：
   - 应该看到 `🎨 调整视频质量` 日志
   - 应该看到 `🔧 updateConfig 被调用` 日志
   - 应该看到 `📤 已发送实时配置更新` 日志
   - 应该看到绿色成功提示："视频质量已调整为 X Mbps"

如果以上任何一步失败，请按照上面的检查步骤进行排查。

### 获取帮助

如果问题仍未解决，请提供以下信息：

1. 浏览器控制台的完整日志（特别是包含 🔍、🎨、🔧、📤 的日志）
2. 后端控制台的日志
3. 当前的模式（截图模式 / 低延迟视频模式）
4. 连接状态（已连接 / 未连接）
5. 浏览器和版本
