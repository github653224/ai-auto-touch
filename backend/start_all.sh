#!/bin/bash

#==============================================================================
# AI Auto Touch - 统一启动脚本
#==============================================================================
# 功能: 提供服务启动指南和状态检查
# 用法: ./start_all.sh
# 说明: 此脚本会提示用户分别启动各个服务，以便查看日志和调试
#==============================================================================

echo "=========================================="
echo "AI Auto Touch - 服务启动指南"
echo "=========================================="
echo ""
echo "为了便于查看日志和调试，建议分别启动各个服务："
echo ""

#------------------------------------------------------------------------------
# 启动顺序说明
#------------------------------------------------------------------------------
echo "📋 启动顺序："
echo ""
echo "1️⃣  AI 模型服务 (端口 8000) - 可选"
echo "   如果使用本地部署的模型，在新终端窗口运行:"
echo "   cd $(pwd)"
echo "   ./start_model.sh"
echo ""
echo "   如果使用远程 API 服务（智谱 AI、ModelScope 等），跳过此步骤"
echo ""
echo "2️⃣  后端主服务 (端口 8001) - 必需"
echo "   在新终端窗口运行:"
echo "   cd $(pwd)"
echo "   ./start_backend.sh"
echo ""
echo "3️⃣  前端服务 (端口 5173) - 必需"
echo "   在另一个新终端窗口运行:"
echo "   cd ../frontend"
echo "   npm run dev"
echo ""

#------------------------------------------------------------------------------
# 服务说明
#------------------------------------------------------------------------------
echo "=========================================="
echo "服务说明："
echo "=========================================="
echo ""
echo "• start_model.sh    - AI 模型服务（vLLM），仅本地部署时需要"
echo "• start_backend.sh  - 后端主服务（FastAPI），前台运行，显示日志"
echo "• stop_all.sh       - 停止所有服务"
echo ""
echo "注意: 如果使用远程 API 服务，无需启动 start_model.sh"
echo ""

#------------------------------------------------------------------------------
# 快速启动命令
#------------------------------------------------------------------------------
echo "=========================================="
echo "快速启动命令："
echo "=========================================="
echo ""
echo "终端1 - AI 模型服务（仅本地部署）:"
echo "  ./start_model.sh"
echo ""
echo "终端2 - 后端主服务:"
echo "  ./start_backend.sh"
echo ""
echo "终端3 - 前端服务:"
echo "  cd ../frontend && npm run dev"
echo ""

#------------------------------------------------------------------------------
# 服务状态检查函数
#------------------------------------------------------------------------------
# 参数:
#   $1 - 端口号
#   $2 - 服务名称
#   $3 - 健康检查 URL（可选）
# 返回:
#   0 - 服务正常运行
#   1 - 端口被占用但服务可能不健康
#   2 - 服务未运行
#------------------------------------------------------------------------------
check_service_status() {
    local port=$1
    local service=$2
    local health_url=$3
    
    # 检查端口是否被占用
    if lsof -Pi :${port} -sTCP:LISTEN -t >/dev/null 2>&1; then
        # 如果提供了健康检查 URL，进行健康检查
        if [ ! -z "$health_url" ]; then
            if curl -s "$health_url" > /dev/null 2>&1; then
                echo "✓ ${service} 正在运行 (端口 ${port})"
                return 0
            else
                echo "⚠️  ${service} 端口被占用但服务可能不健康 (端口 ${port})"
                return 1
            fi
        else
            echo "⚠️  ${service} 端口被占用 (端口 ${port})"
            return 1
        fi
    else
        echo "✗ ${service} 未运行 (端口 ${port})"
        return 2
    fi
}

#------------------------------------------------------------------------------
# 检查当前服务状态
#------------------------------------------------------------------------------
echo "=========================================="
echo "检查服务状态："
echo "=========================================="
echo ""

# 检查 AI 模型服务（端口 8000）
# 注意: 如果使用远程 API，此服务不需要运行
if grep -q "localhost:8000" .env 2>/dev/null; then
    echo "检测到本地模型配置，检查模型服务..."
    check_service_status 8000 "AI 模型服务" "http://localhost:8000/v1/models"
else
    echo "✓ 使用远程 API 服务（跳过本地模型服务检查）"
fi

# 检查后端主服务（端口 8001）
check_service_status 8001 "后端主服务" "http://localhost:8001/docs"

# 检查前端服务（端口 5173）
check_service_status 5173 "前端服务" ""

echo ""
echo "=========================================="
echo ""
echo "提示: 如需停止所有服务，运行: ./stop_all.sh"
echo ""
echo "=========================================="
