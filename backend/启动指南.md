# 后端启动指南

## 快速启动

### 方式一：使用启动脚本（推荐）

#### 使用Conda环境（推荐）

如果你使用conda环境（环境名：ai-auto-touch）：

```bash
cd backend
./start_conda.sh
```

或者：

```bash
cd backend
bash start_conda.sh
```

#### 使用venv环境

如果你使用venv虚拟环境：

```bash
cd backend
./start.sh
```

或者：

```bash
cd backend
bash start.sh
```

### 方式二：手动启动

#### 1. 进入后端目录

```bash
cd backend
```

#### 2. 创建并激活虚拟环境

**使用Conda（推荐）：**

```bash
# 创建conda环境
conda create -n ai-auto-touch python=3.10

# 激活conda环境
conda activate ai-auto-touch
```

**或使用venv：**

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate
```

#### 3. 安装依赖

```bash
# 升级pip
pip install --upgrade pip

# 安装后端依赖
pip install -r requirements.txt

# 安装Open-AutoGLM（如果还未安装）
cd ../Open-AutoGLM
pip install -e .
cd ../backend
```

#### 4. 配置环境变量（可选）

创建 `.env` 文件：

```bash
# 后端服务配置
HOST=0.0.0.0
PORT=8001
DEBUG=True
WORKERS=1

# ADB和scrcpy路径
ADB_PATH=adb
SCRCPY_PATH=scrcpy

# AI模型服务配置（确保vLLM服务已启动在8000端口）
AUTOGLM_BASE_URL=http://localhost:8000/v1
AUTOGLM_MODEL_NAME=autoglm-phone-9b
AUTOGLM_MAX_STEPS=100

# 设备配置
MAX_DEVICES=100
SCREENSHOT_INTERVAL=1
```

#### 5. 启动服务

```bash
# 方式1: 使用uvicorn命令
uvicorn main:app --host 0.0.0.0 --port 8001 --reload

# 方式2: 直接运行main.py
python main.py
```

## 启动前检查清单

- [ ] Python 3.8-3.11 已安装
- [ ] 虚拟环境已创建并激活（conda或venv）
- [ ] 后端依赖已安装（`pip install -r requirements.txt`）
- [ ] Open-AutoGLM已安装（`cd ../Open-AutoGLM && pip install -e .`）
- [ ] ADB已安装并添加到PATH（`adb --version`）
- [ ] scrcpy已安装并添加到PATH（`scrcpy --version`）
- [ ] **AI模型服务已启动**（重要！）
  - 方案1: vLLM服务运行在8000端口（推荐）
    - 快速启动：`./start_vllm.sh`
    - 详细说明：参考 `vLLM启动指南.md` 或 `README.md` 1.3.3节
  - 方案2: 运行 `./start_local_model.sh` 启动本地模型服务（不推荐，GLM4V模型不支持）
- [ ] 端口8001未被占用（后端服务端口）

## 验证启动

启动成功后，访问以下地址：

- **API根路径**: http://localhost:8001
- **API文档**: http://localhost:8001/docs
- **ReDoc文档**: http://localhost:8001/redoc

## 常见问题

### 1. 端口被占用

如果8001端口被占用，可以：

- 修改 `.env` 文件中的 `PORT` 值
- 或使用命令指定端口：`uvicorn main:app --port 8002`

### 2. phone_agent导入错误

确保已安装Open-AutoGLM：

```bash
cd ../Open-AutoGLM
pip install -e .
```

### 3. ADB命令找不到

- macOS: `brew install android-platform-tools`
- Linux: `sudo apt install android-tools-adb`
- Windows: 下载Platform Tools并添加到PATH

### 4. AI服务连接失败

确保AI模型服务已启动（二选一）：

**方案1: 使用vLLM（推荐）**
```bash
# 快速启动
cd backend
./start_vllm.sh

# 检查服务是否运行
curl http://localhost:8000/v1/models

# 详细说明请参考 vLLM启动指南.md
```

**方案2: 使用local_api.py（简单）**
```bash
# 启动本地模型服务
cd backend
./start_local_model.sh

# 或手动启动
conda activate ai-auto-touch
python local_api.py
```

详细说明请参考 `模型服务说明.md`

## 开发模式

开发时建议使用 `--reload` 参数，代码修改后自动重启：

```bash
uvicorn main:app --host 0.0.0.0 --port 8001 --reload
```

## 生产模式

生产环境建议：

1. 设置 `DEBUG=False`
2. 使用多个worker：`--workers 4`
3. 使用反向代理（如Nginx）
4. 配置HTTPS

```bash
uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
```

