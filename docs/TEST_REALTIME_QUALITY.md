# 实时画质设置功能测试指南

## 测试前准备

1. 确保后端服务正在运行
2. 确保至少有一个设备已连接
3. 打开浏览器开发者工具的控制台，以便查看日志

## 测试步骤

### 1. 进入屏幕显示页面

1. 在设备管理页面，点击某个已连接设备的"查看屏幕"按钮
2. 或直接进入"屏幕显示"页面并选择设备

### 2. 切换到低延迟视频模式

1. 在右侧"设备与画质设置"标签页中
2. 找到"显示模式"开关
3. 将开关切换到"低延迟视频"模式
4. 等待视频流连接成功（状态显示为"已连接"）

### 3. 测试视频质量实时调整

1. 在"视频质量"滑块处，当前值应该显示为 4 Mbps
2. 拖动滑块到不同的值（例如 2 Mbps）
3. **预期结果**：
   - 立即看到提示消息："视频质量已调整为 2 Mbps"（绿色成功提示）
   - 控制台显示：`📤 已发送实时配置更新: 分辨率=1080p, 比特率=2Mbps`
   - 视频流会短暂中断（1-2秒），然后恢复
   - 视频质量应该有明显变化（比特率降低，画质可能略有下降）

4. 再次调整到更高的值（例如 5 Mbps）
5. **预期结果**：
   - 同样看到成功提示
   - 视频流重启后画质应该提升

### 4. 测试分辨率实时调整

1. 在"分辨率"滑块处，当前值应该显示为 1080p
2. 拖动滑块到不同的值（例如 720p）
3. **预期结果**：
   - 立即看到提示消息："分辨率已调整为 720p"（绿色成功提示）
   - 控制台显示：`📤 已发送实时配置更新: 分辨率=720p, 比特率=4Mbps`
   - 视频流会短暂中断（1-2秒），然后恢复
   - 视频分辨率应该降低，画面可能变小或模糊

4. 调整到更高分辨率（例如 2160p / 4K）
5. **预期结果**：
   - 同样看到成功提示
   - 视频流重启后分辨率应该提升（如果设备支持）

### 5. 测试截图模式（对比）

1. 将"显示模式"开关切换回"截图模式"
2. 调整视频质量或分辨率
3. **预期结果**：
   - 看到提示消息："视频质量已调整为 X Mbps，将在下次连接时生效"（蓝色信息提示）
   - 配置不会立即生效
   - 需要重新连接才能应用新配置

## 验证要点

### 前端验证

1. **提示消息正确**：
   - 低延迟视频模式：显示绿色成功提示，不包含"将在下次连接时生效"
   - 截图模式：显示蓝色信息提示，包含"将在下次连接时生效"

2. **控制台日志**：
   - 应该看到 `📤 已发送实时配置更新` 日志
   - 应该看到 WebSocket 发送配置消息的日志

### 后端验证

1. **后端日志**（查看后端控制台）：
   ```
   设备 <device_id>: 更新H264配置 - max_size=720, bit_rate=2000000
   设备 <device_id>: 配置已更新，需要重启流以应用新配置
   设备 <device_id> H264 视频流已停止
   设备 <device_id>: 启动H264流 - max_size=720, bit_rate=2000000
   ```

2. **WebSocket 消息**：
   - 后端应该发送 `config_updated` 消息给前端

### 视频流验证

1. **视频质量变化**：
   - 降低比特率：画质应该下降，可能出现更多压缩伪影
   - 提高比特率：画质应该提升，画面更清晰

2. **分辨率变化**：
   - 降低分辨率：画面应该变小或模糊
   - 提高分辨率：画面应该更清晰（如果设备支持）

3. **重启时间**：
   - 视频流重启应该在 1-2 秒内完成
   - 不应该出现长时间黑屏或卡死

## 常见问题

### 1. 配置更新后视频流没有重启

**可能原因**：
- WebSocket 连接未建立
- 后端服务异常

**解决方法**：
- 检查浏览器控制台是否有错误
- 检查后端日志是否有异常
- 尝试刷新页面重新连接

### 2. 配置更新后画质/分辨率没有变化

**可能原因**：
- 设备不支持请求的分辨率
- 比特率变化不够明显

**解决方法**：
- 尝试更大的调整幅度（例如从 5 Mbps 降到 1 Mbps）
- 检查设备是否支持高分辨率（4K）

### 3. 视频流重启后无法恢复

**可能原因**：
- 后端 scrcpy 进程异常
- 设备连接断开

**解决方法**：
- 检查后端日志
- 尝试重新连接设备
- 切换到截图模式

## 性能测试

### 测试不同配置的性能

1. **低配置**（适合网络较差的情况）：
   - 分辨率：480p
   - 比特率：1 Mbps
   - 预期：流畅但画质较差

2. **中等配置**（推荐）：
   - 分辨率：1080p
   - 比特率：4 Mbps
   - 预期：画质和流畅度平衡

3. **高配置**（适合本地网络）：
   - 分辨率：2160p (4K)
   - 比特率：5 Mbps
   - 预期：画质最佳，但可能有延迟

### 测试频繁调整

1. 快速连续调整画质（例如 1 Mbps -> 3 Mbps -> 5 Mbps）
2. **预期结果**：
   - 每次调整都应该触发重启
   - 不应该出现崩溃或卡死
   - 最终应该应用最后一次的配置

## 测试完成标准

- ✅ 低延迟视频模式下，画质调整立即生效
- ✅ 低延迟视频模式下，分辨率调整立即生效
- ✅ 截图模式下，配置调整提示"将在下次连接时生效"
- ✅ 视频流重启时间在 1-2 秒内
- ✅ 配置更新后画质/分辨率有明显变化
- ✅ 频繁调整不会导致崩溃或卡死
- ✅ 前端和后端日志正常，无错误
